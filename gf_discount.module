<?php
/**
* @file
* A description of what your module does.
*/

define("EXTRA_10_MANAGER_ID", 19);
define("EXTRA_10_USER_ID", 18);

/**
 * Implements hook_uc_cart_alter().
 */
function gf_discount_uc_cart_alter(&$items) {
  $discount_coefficient = 1;

  if (user_has_role(EXTRA_10_MANAGER_ID) or user_has_role(EXTRA_10_USER_ID)) { $extra_10 = true; }

  foreach ($items as $key => $item) {

    $discount = FALSE;


    if (isset($item->field_discount['und'])) {
      $field_discount_tid = $item->field_discount['und'][0]['tid'];
      $discount_term = taxonomy_term_load($field_discount_tid);
      $discount_raw_percent = $discount_term->name;
      $discount_percent = substr($discount_raw_percent, 0, strpos($discount_raw_percent, '%'));
      $discount = TRUE;
    }

    $result_price = $item->price * $discount_coefficient;
    if ($discount) {
      if ($extra_10) {
        $discount_percent += 10;
      }
      $discount_coefficient = 1.0 - ($discount_percent / 100);
      $item->price = $result_price;
      $item->sell_price = $result_price;
    } elseif ($extra_10) {
      $discount_coefficient = 0.9;
      $item->price = $result_price;
      $item->sell_price = $result_price;
    }
  }
}
